<!DOCTYPE html>
<html lang="en">

	<head>


		<link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.4.3/css/flag-icon.css">


		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/js/select2.min.js"></script>
		<script src="https://d3js.org/d3.v3.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>



		<style>

			body {
			  font: 16px arial;
			}

			#basemaps-wrapper {
				position: absolute;
				top:30px;
				left: 750px;
				background: white;
			}

			#chart{
				position: absolute;
				top: 10px;
				left: 0px;
				width: 600px;
			}


			.line {
			  fill: none;
			  stroke: steelblue;
			  stroke-width: 2px;
			}

			ul.select2-results {
			 max-height: 200px;
			}



		</style>

	</head>

	<body>





		<div id="basemaps-wrapper">
			<select id="multiSelect" class="js-example-basic-multiple" name="states[]" multiple="multiple" style="width: 250px">
				<option value="t">Total</option>
				<option value="ld">Licenciatura</option>
				<option value="b">Grado</option>
				<option value="m">Máster</option>
				<option value="d">Doctorado</option>
				<option value="wva">Otros</option>
			</select>
		</div>

		<div id="chart"></div>

		<script>



		var data = {
		   "schema":{
		      "fields":[
		         {
		            "name":"index",
		            "type":"integer"
		         },
		         {
		            "name":"type",
		            "type":"string"
		         },
		         {
		            "name":"1988",
		            "type":"integer"
		         },
		         {
		            "name":"1989",
		            "type":"integer"
		         },
		         {
		            "name":"1990",
		            "type":"integer"
		         },
		         {
		            "name":"1991",
		            "type":"integer"
		         },
		         {
		            "name":"1992",
		            "type":"integer"
		         },
		         {
		            "name":"1993",
		            "type":"integer"
		         },
		         {
		            "name":"1994",
		            "type":"integer"
		         },
		         {
		            "name":"1995",
		            "type":"integer"
		         },
		         {
		            "name":"1996",
		            "type":"integer"
		         },
		         {
		            "name":"1997",
		            "type":"integer"
		         },
		         {
		            "name":"1998",
		            "type":"integer"
		         },
		         {
		            "name":"1999",
		            "type":"integer"
		         },
		         {
		            "name":"2000",
		            "type":"integer"
		         },
		         {
		            "name":"2001",
		            "type":"integer"
		         },
		         {
		            "name":"2002",
		            "type":"integer"
		         },
		         {
		            "name":"2003",
		            "type":"integer"
		         },
		         {
		            "name":"2004",
		            "type":"integer"
		         },
		         {
		            "name":"2005",
		            "type":"integer"
		         },
		         {
		            "name":"2006",
		            "type":"integer"
		         },
		         {
		            "name":"2007",
		            "type":"integer"
		         },
		         {
		            "name":"2008",
		            "type":"integer"
		         },
		         {
		            "name":"2009",
		            "type":"integer"
		         },
		         {
		            "name":"2010",
		            "type":"integer"
		         },
		         {
		            "name":"2011",
		            "type":"integer"
		         },
		         {
		            "name":"2012",
		            "type":"integer"
		         },
		         {
		            "name":"2013",
		            "type":"integer"
		         },
		         {
		            "name":"2014",
		            "type":"integer"
		         },
		         {
		            "name":"2015",
		            "type":"integer"
		         },
		         {
		            "name":"2016",
		            "type":"integer"
		         },
		         {
		            "name":"2017",
		            "type":"integer"
		         },
		         {
		            "name":"2018",
		            "type":"integer"
		         },
		         {
		            "name":"code",
		            "type":"string"
		         }
		      ],
		      "primaryKey":[
		         "index"
		      ],
		      "pandas_version":"0.20.0"
		   },
		   "data":[
		      {
		         "index":0,
		         "type":"Total",
		         "1988":288,
		         "1989":291,
		         "1990":306,
		         "1991":304,
		         "1992":350,
		         "1993":353,
		         "1994":362,
		         "1995":334,
		         "1996":365,
		         "1997":357,
		         "1998":377,
		         "1999":386,
		         "2000":415,
		         "2001":434,
		         "2002":457,
		         "2003":511,
		         "2004":543,
		         "2005":433,
		         "2006":387,
		         "2007":389,
		         "2008":369,
		         "2009":349,
		         "2010":357,
		         "2011":307,
		         "2012":299,
		         "2013":307,
		         "2014":286,
		         "2015":268,
		         "2016":237,
		         "2017":218,
		         "2018":192,
		         "code":"t"
		      },
		      {
		         "index":1,
		         "type":"Lizenziat \/ Diplom",
		         "1988":243,
		         "1989":245,
		         "1990":255,
		         "1991":258,
		         "1992":301,
		         "1993":316,
		         "1994":335,
		         "1995":311,
		         "1996":328,
		         "1997":309,
		         "1998":335,
		         "1999":340,
		         "2000":368,
		         "2001":386,
		         "2002":425,
		         "2003":462,
		         "2004":485,
		         "2005":338,
		         "2006":246,
		         "2007":197,
		         "2008":140,
		         "2009":99,
		         "2010":81,
		         "2011":54,
		         "2012":43,
		         "2013":35,
		         "2014":30,
		         "2015":14,
		         "2016":8,
		         "2017":5,
		         "2018":12,
		         "code":"ld"
		      },
		      {
		         "index":2,
		         "type":"Bachelor",
		         "1988":0,
		         "1989":0,
		         "1990":0,
		         "1991":0,
		         "1992":0,
		         "1993":0,
		         "1994":0,
		         "1995":0,
		         "1996":0,
		         "1997":0,
		         "1998":0,
		         "1999":0,
		         "2000":0,
		         "2001":0,
		         "2002":0,
		         "2003":11,
		         "2004":16,
		         "2005":34,
		         "2006":73,
		         "2007":102,
		         "2008":120,
		         "2009":126,
		         "2010":143,
		         "2011":115,
		         "2012":127,
		         "2013":114,
		         "2014":104,
		         "2015":107,
		         "2016":91,
		         "2017":66,
		         "2018":50,
		         "code":"b"
		      },
		      {
		         "index":3,
		         "type":"Master",
		         "1988":0,
		         "1989":0,
		         "1990":0,
		         "1991":0,
		         "1992":0,
		         "1993":0,
		         "1994":0,
		         "1995":0,
		         "1996":0,
		         "1997":0,
		         "1998":0,
		         "1999":0,
		         "2000":0,
		         "2001":0,
		         "2002":0,
		         "2003":0,
		         "2004":0,
		         "2005":5,
		         "2006":7,
		         "2007":31,
		         "2008":46,
		         "2009":61,
		         "2010":70,
		         "2011":80,
		         "2012":80,
		         "2013":101,
		         "2014":89,
		         "2015":85,
		         "2016":74,
		         "2017":90,
		         "2018":72,
		         "code":"m"
		      },
		      {
		         "index":4,
		         "type":"Doktorat",
		         "1988":28,
		         "1989":30,
		         "1990":34,
		         "1991":30,
		         "1992":35,
		         "1993":28,
		         "1994":23,
		         "1995":19,
		         "1996":27,
		         "1997":33,
		         "1998":29,
		         "1999":33,
		         "2000":36,
		         "2001":34,
		         "2002":32,
		         "2003":37,
		         "2004":41,
		         "2005":53,
		         "2006":55,
		         "2007":53,
		         "2008":54,
		         "2009":58,
		         "2010":58,
		         "2011":49,
		         "2012":42,
		         "2013":54,
		         "2014":54,
		         "2015":54,
		         "2016":57,
		         "2017":55,
		         "2018":50,
		         "code":"d"
		      },
		      {
		         "index":5,
		         "type":"Weiterbildung, Vertiefung und andere",
		         "1988":17,
		         "1989":16,
		         "1990":17,
		         "1991":16,
		         "1992":14,
		         "1993":9,
		         "1994":4,
		         "1995":4,
		         "1996":10,
		         "1997":15,
		         "1998":13,
		         "1999":13,
		         "2000":11,
		         "2001":14,
		         "2002":0,
		         "2003":1,
		         "2004":1,
		         "2005":3,
		         "2006":6,
		         "2007":6,
		         "2008":9,
		         "2009":5,
		         "2010":5,
		         "2011":9,
		         "2012":7,
		         "2013":3,
		         "2014":9,
		         "2015":8,
		         "2016":7,
		         "2017":2,
		         "2018":8,
		         "code":"wva"
		      }
		   ]
		}


		data = restructureData(data.data);
		console.log(data);



		$("#multiSelect").select2({
			placeholder: "Seleccione un grado académico ",
			templateSelection: formatSelections,
			templateResult: formatSelections,
			width: 'resolve'
		});



		function formatSelections(stufe) {
			return stufe.text;
		};





		$('#multiSelect').on('change', function (e) {
			var options = e.currentTarget.selectedOptions,
				i;
			// console.log(options);

			// de-select all countries
			Object.keys(data).forEach(function(country) {
				data[country].active = false
			});

			// select countries according to multi select
			for (i = 0; i < options.length; i++) {
				data[options[i].value].active = true;
			};

			printSelected(data);
			updateSelection(data)

		});






		  // set the dimensions and margins of the graph
		var margin = {top: 20, right: 20, bottom: 100, left: 100},
			width = 750 - margin.left - margin.right,
			height = 450 - margin.top - margin.bottom;

		// append the svg obgect to the body of the page
		// appends a 'group' element to 'svg'
		// moves the 'group' element to the top left margin
		var svg = d3.select("#chart")
			.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
			.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");





		// .domain(d3.extent(data[oldSelected[0]], function(d) { return d.date; }))

		// set the ranges
		var xScale = d3.scaleTime()
			.domain(d3.extent(data.b.data, function(d) { return d.date; }))
			.range([0, width]);

		// d3.max(data[oldSelected[0]], function(d) { return d.value; })
		var yScale = d3.scaleLinear()
			.domain([0, 0])
			.range([height, 0]);


		// Define the axes
		var xAxis = d3.axisBottom().scale(xScale).ticks(5);
		var yAxis = d3.axisLeft().scale(yScale).ticks(5);


		// define the line
		var valueline = d3.line()
			.x(function(d) { return xScale(d.date); })
			.y(function(d) { return yScale(d.value); });

		var color = d3.scale.category10();

		Object.keys(data).forEach(function(country) {
			// Add the valueline path.
			svg.append("path")
				.attr("class", "line")
				.attr("d", valueline(data[country].data))
				.style("stroke", color(country))
				.style("opacity", 0)
				.attr("id", 'tag' + data[country].id);
		});


		// Add the X Axis
		svg.append("g")
			.attr("transform", "translate(0," + height + ")")
			.style("font-size", "16px")
			.call(xAxis);

		// Add the Y Axis
		svg.append("g")
			.attr("class", "y axis")
			.style("font-size", "16px")
			.call(yAxis);


		// text label for the x axis
		svg.append("text")
			.attr("transform",
				  "translate(" + (width/2 - 10) + " ," +
								 (height + margin.top + 30) + ")")
			.style("text-anchor", "middle")
			.style("font-size", "16px")
			.text("Año");

		// text label for the y axis
		svg.append("text")
			.attr("transform", "rotate(-90)")
			.attr("y", 30 - margin.left)
			.attr("x", 0 - (height / 2))
			.attr("dy", "1em")
			.style("text-anchor", "middle")
			.style("font-size", "16px")
			.text("Número de estudiantes");



		function updateSelection(data) {


			var i,
				opacity;
				yMax = 0;

			// Select the section we want to apply our changes to
			var svg = d3.select("#chart").transition();

			// defining transition
			var t = d3.transition()
				.duration(750)

			// updating range of y axis
			Object.keys(data).forEach(function(country) {
				if (data[country].active) {
					yMax = Math.max(yMax, d3.max(data[country].data, function (d) { return d.value;} ));
				};
			});
			console.log(yMax);

			yScale = d3.scaleLinear()
				.domain([0, yMax])
				.range([height, 0]);

			svg.select(".y")
				.transition(t)
				.call(yAxis.scale(yScale));


			// updating selection by adjusting opacities of lines
			Object.keys(data).forEach(function(country) {

				opacity = data[country].active ? 1 : 0;

				d3.select('#tag' + data[country].id)
					.transition().duration(100)
					.attr('d', valueline(data[country].data))
					.style("opacity", opacity);
			});


		};


		function restructureData(data) {

			var dataRestructured = {},
				parseTime = d3.timeParse("%Y"),
				stufeData,
				startYear = 1988,
				endYear = 2018,
				i,
				year;

			// loop over all countries
			for (i = 0; i < data.length; i++) {

				stufeData = [];
				for (year = startYear; year <= endYear; year++) {
					stufeData.push({
						date: parseTime(year),
						value: data[i][year]
					});
				};

				dataRestructured[data[i].code] = {
					data: stufeData,
					active: false,
					id: 'stufe' + i,
					code: data[i].code,
				};
			};
			return dataRestructured;
		};

		// just for debugging
		function printSelected(data) {
			var str = ''
			Object.keys(data).forEach(function(country) {
				if (data[country].active) {
					str += country + ' ';
				}
			});
			console.log(str);
		};

		</script>
	</body>

</html>
